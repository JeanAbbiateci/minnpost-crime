/*! minnpost-crime - v0.0.1 - 2013-06-19
* https://github.com/MinnPost/minnpost-crime
* Copyright (c) 2013 ; Licensed MIT */

var mpApp=mpApp||{};mpApp["minnpost-crime"]=mpApp["minnpost-crime"]||{},_.mixin({formatNumber:function(t,e){e=e||2;var n=/(\d+)(\d{3})/;for(split=(""+t.toFixed(e)).split(".");n.test(split[0]);)split[0]=split[0].replace(n,"$1,$2");return split[0]+"."+split[1]},formatCurrency:function(t){return"$"+_.formatNumber(t,2)},formatPercent:function(t){return""+(100*t).toFixed(1)+"%"}}),_.isFunction(Backbone.$.jsonp)&&(Backbone.ajax=function(){return Backbone.$.jsonp.apply(Backbone.$,arguments)}),function(t,e){t.defaultOptions={dataPath:"./data/",dataCrimeQueryBase:"https://api.scraperwiki.com/api/1.0/datastore/sqlite?format=jsondict&name=minneapolis_aggregate_crime_data&callback=?&query=[[[QUERY]]]",dataCrimeQueryWhere:"notes NOT LIKE 'Added to%'"},t.templates=t.templates||{},t.getTemplate=function(n,i,a){var o="js/templates/"+n+".html";a=a||t,_.isUndefined(t.templates[o])?e.ajax({url:o,method:"GET",async:!1,contentType:"text",success:function(e){t.templates[o]=_.template(e),i.apply(a,[t.templates[o]])}}):i.apply(a,[t.templates[o]])},t.data=t.data||{},t.getLocalData=function(n){var i="http://mp-jsonproxy.herokuapp.com/proxy?callback=?&url=",a=!1,o=[];return n=_.isArray(n)?n:[n],t.options&&0===t.options.dataPath.indexOf("http")&&(a=!0),_.each(n,function(s){var r;_.isUndefined(t.data[n])&&(r=a?e.jsonp({url:i+encodeURI(t.options.dataPath+s+".json")}):e.getJSON(t.options.dataPath+s+".json"),e.when(r).done(function(e){t.data[s]=e}),o.push(r))}),e.when.apply(e,o)}}(mpApp["minnpost-crime"],jQuery),this.mpApp=this.mpApp||{},this.mpApp["minnpost-crime"]=this.mpApp["minnpost-crime"]||{},this.mpApp["minnpost-crime"].templates=this.mpApp["minnpost-crime"].templates||{},this.mpApp["minnpost-crime"].templates["js/templates/template-application-container.html"]=function(obj){obj||(obj={});var __p="";with(_.escape,obj)__p+='<div class="mc-application-container">\n    \n  <div class="flurid mc-header">\n    <div class="row">\n      <div class="column width_1/1">\n      </div>\n    </div>\n    \n    <div class="row messaging-container">\n      <div class="column width_1/1">\n      \n      </div>\n    </div>\n  </div>\n  \n  <div class="mc-content">\n  </div>\n    \n    \n  <div class="flurid mc-footer">\n    <div class="row">\n      <div class="column width_1/1">\n        \n        <p>Footer</p>\n      \n      </div>\n    </div>\n  </div>\n</div>';return __p},this.mpApp["minnpost-crime"].templates["js/templates/template-city.html"]=function(obj){obj||(obj={});var __t,__p="";with(_.escape,Array.prototype.join,obj)__p+='<div class="mc-city-container">\n  <div class="flurid">\n    <div class="row row-space">\n      <div class="column width_1/1">\n        <h2 class="section-title"></h2>\n      </div>\n    </div>\n  \n    <div class="row row-space">\n      <div class="column width_1/2">\n        <div class="inner-column-left">\n          <div class="map placeholder">\n            Map <span class="month-display"></span>\n          </div>\n        </div>\n      </div>\n      \n      <div class="column width_1/2 last">\n        <h3>Current Month</h3>\n        <p class="current-month-display"></p>\n        \n        <h3>Total Crime</h3>\n      \n        <div class="column width_1/2">\n          <div class="inner-column-left">\n            <div class="stat-last-month">\n              <p>Change from last month</p>\n              <span class="stat-value"></span>\n              <span class="stat-symbol"></span>\n            </div>\n          </div>\n        </div>\n      \n        <div class="column width_1/2">\n          <div class="inner-column-left">\n            <div class="stat-last-year">\n              <p>Change from last year</p>\n              <span class="stat-value"></span>\n              <span class="stat-symbol"></span>\n            </div>\n          </div>\n        </div>\n        \n      </div>\n    </div>\n    \n    <div class="row row-space city-category-stats">\n      <h4>Crime changes from last month</h4>\n      ',_.each(categories,function(t,e){"total"!==e&&(__p+='\n        <div class="city-category-stat city-category-stat-'+(null==(__t=e)?"":__t)+" column width_1/"+(null==(__t=_.size(categories)-1)?"":__t)+'">\n          <div class="stat-label">'+(null==(__t=t.title)?"":__t)+'</div>\n          <div class="stat-value"></div>\n        </div>\n      ')}),__p+='\n    </div>\n    \n    <div class="row">\n      <div class="column width_1/1 last">\n        <h4>Crime over the past year</h4>\n        <div id="chart-one"></div>\n      </div>\n    </div>\n  </div>\n</div>';return __p},this.mpApp["minnpost-crime"].templates["js/templates/template-loading.html"]=function(obj){obj||(obj={});var __p="";with(_.escape,obj)__p+='<div class="loading-container">\n  <div class="loading"><span>Loading...</span></div>\n</div>';return __p},function(t){t.Application=Backbone.Router.extend({routes:{"city/:city":"routeCity","neighborhood/:city/:neighborhood":"routeNeighborhood","*defaultR":"routeDefault"},initialize:function(e){var n=this;_.bindAll(this),t.options=_.extend(t.defaultOptions,e),this.applicationView=new t.ViewContainer({el:t.options.el}).render().renderGeneralLoading(),this.cities=new t.CollectionCities,this.neighborhoods=new t.CollectionNeighborhoods,this.cityView=new t.ViewCity,this.neighborhoodView=new t.ViewNeighborhood,t.getLocalData(["crime/categories","cities/cities"]).done(function(){n.start()})},start:function(){Backbone.history.start()},routeDefault:function(){this.navigate("/city/minneapolis",{trigger:!0,replace:!0})},routeCity:function(e){var n=this;_.isUndefined(t.data["cities/cities"][e])&&this.routeDefault(),this.applicationView.renderGeneralLoading(),this.city=this.cities.get(e),_.isUndefined(this.city)&&(this.city=new t.ModelCity({id:e}),this.cities.add(this.city)),this.applicationView.renderContent(this.cityView,this.city),this.city.fetchData(function(){n.applicationView.renderStopGeneralLoading()})},routeNeighborhood:function(){}}),t.start=function(e){return t.router=new t.Application(e),t}}(mpApp["minnpost-crime"],jQuery),function(t,e){t.ModelCity=Backbone.Model.extend({initialize:function(){this.set("categories",t.data["crime/categories"]),this.set("title","Minneapolis profile")},setStats:function(t){return t=t||"total",this.set("lastMonthChange",this.getMonthChange(this.get("lastMonthYear"),this.get("lastMonthMonth"),t)),this.set("lastYearMonthChange",this.getMonthChange(this.get("currentYear")-1,this.get("currentMonth"),t)),this},getLastYearData:function(t){t=t||"total";var e=[];return _.isObject(this.get("crimeData"))&&_.each(this.get("crimeData"),function(n,i){_.each(n,function(n,a){e.push([i+"-"+a,n[t]])})}),e},getMonthChange:function(t,e,n,i,a){i=i||this.get("currentYear"),a=a||this.get("currentMonth"),n=n||"total";var o=this.getCrimeByMonth(t,e,n),s=this.getCrimeByMonth(i,a,n);return(s-o)/(0===o?.1:o)},getCrimeByMonth:function(t,e,n){return n=n||"total",this.get("crimeData")[t][e][n]},setLastMonth:function(){var t=this.get("currentMonth"),e=this.get("currentYear"),n=[e,t-1];return 1==t&&(n=[e-1,12]),this.set("lastMonthMonth",n[1]),this.set("lastMonthYear",n[0]),this},fetchData:function(t,n){var i=this;return n=n||this,this.fetchRecentMonth(function(a,o){var s=[];this.set("currentMonth",o),this.set("currentYear",a),this.setLastMonth(),s.push(this.fetchDataPreviousYear(a,o)),e.when.apply(e,s).done(function(){var e=i.get("data")||{};_.each(arguments[0],function(t){e[t.year]=e[t.year]||{},e[t.year][t.month]=t}),i.set("crimeData",e),i.setStats(),t.apply(n,[])})},this),this},fetchRecentMonth:function(n,i){i=i||this;var a="SELECT month, year FROM swdata ORDER BY year || '-' || month DESC LIMIT 1",o=e.jsonp({url:t.options.dataCrimeQueryBase.replace("[[[QUERY]]]",encodeURI(a))});return _.isFunction(n)&&e.when(o).done(function(t){n.apply(i,[t[0].year,t[0].month])}),o},fetchDataPreviousYear:function(n,i,a,o){var s=[];s.push("SELECT year, month"),_.each(this.get("categories"),function(t,e){s.push(", SUM("+e+") AS "+e)}),s.push(" FROM swdata WHERE "+t.options.dataCrimeQueryWhere),s.push(" AND ((year = "+n+" AND month <= "+i+") "),s.push(" OR (year = "+(n-1)+" AND month >= "+i+"))"),s.push(" GROUP BY year, month ORDER BY year DESC, month DESC");var r=e.jsonp({url:t.options.dataCrimeQueryBase.replace("[[[QUERY]]]",encodeURI(s.join("")))});return _.isFunction(a)&&e.when(r).done(function(t){a.apply(o,[t[0]])}),r}}),t.ModelNeighborhood=Backbone.Model.extend({})}(mpApp["minnpost-crime"],jQuery),function(t){t.CollectionCities=Backbone.Collection.extend({model:t.ModelCity}),t.CollectionNeighborhoods=Backbone.Collection.extend({model:t.ModelNeighborhood})}(mpApp["minnpost-crime"],jQuery),function(t,e){t.ViewContainer=Backbone.View.extend({render:function(){return t.getTemplate("template-application-container",function(t){e(this.el).html(t({}))},this),this},renderContent:function(t,n){var i=!1;return this.el+" .mc-content col",this.contentViewCID!==t.cid&&(i=!0),t.setElement(e(this.el).find(".mc-content")),t.model=n,i&&t.render(),t.stickit(),this.contentViewCID=t.cid,this},renderLoading:function(n){var i=_.isUndefined(n)?e(this.el):e(this.el).find(n);return t.getTemplate("template-loading",function(t){i.html(t({}))},this),this},renderGeneralLoading:function(){return this.renderLoading(".messaging-container .column"),this},renderStopGeneralLoading:function(){return this.$el.find(".messaging-container .loading").fadeOut(function(){e(this).remove()}),this}}),t.ViewBinding=Backbone.View.extend({bindUpdateCount:function(t,e){var n,i,a=_.isNaN(parseInt(t.text(),10))?0:parseInt(t.text(),10);if(_.isNumber(e)&&e!=a){var o=e>a;n=(e-a)/40,i=setInterval(function(){a+=n,t.html(_.formatPercent(a)),(o&&a>=e||!o&&e>=a)&&(t.html(_.formatPercent(e)),clearInterval(i))},20)}else t.html(e)},bindUpdateFade:function(t,e){t.fadeOut("fast",function(){t.html(e).fadeIn("fast")})}}),t.ViewCity=t.ViewBinding.extend({model:t.ModelCity,bindings:{".current-month-display":{observe:["currentMonth","currentYear"],update:"bindUpdateCurrentMonthDisplay"},".stat-last-month .stat-value":{observe:"lastMonthChange",update:"bindUpdateCount"},".stat-last-year .stat-value":{observe:"lastYearMonthChange",update:"bindUpdateCount"},"#chart-one":{observe:"crimeData",update:"bindUpdateChartOne"},".section-title":"title",".city-category-stats":{observe:"crimeData",update:"bindUpdateCategoryCrime"}},bindUpdateCurrentMonthDisplay:function(t,e,n,i){var a=e?moment(""+e,"MM").format("MMMM"):"",o=n.get("currentYear");this.bindUpdateFade(t,a&&o?a+", "+o:"",n,i)},bindUpdateChartOne:function(t,n,i){data=i.getLastYearData(),_.isArray(data)&&data.length>0&&e.jqplot("chart-one",[data],this.cityPlotOptions)},bindUpdateCategoryCrime:function(t,e,n,i){_.isUndefined(n.get("crimeData"))||_.each(n.get("categories"),function(e,a){var o=n.getMonthChange(n.get("lastMonthYear"),n.get("lastMonthMonth"),a),s=t.find(".city-category-stat-"+a+" .stat-value");this.bindUpdateCount(s,o,n,i)},this)},cityPlotOptions:{seriesColors:["#10517F"],grid:{drawBorder:!1,background:"#fafafa",gridLineColor:"#dddddd",shadow:!1},series:{renderer:e.jqplot.BarRenderer,lineWidth:1.5,shadow:!1,markerOptions:{size:0,shadow:!1},rendererOptions:{barPadding:0,barMargin:2}},axes:{xaxis:{renderer:e.jqplot.CategoryAxisRenderer}}},render:function(){return t.getTemplate("template-city",function(t){this.$el.html(t(this.model.toJSON()))},this),this}}),t.ViewNeighborhood=t.ViewBinding.extend({})}(mpApp["minnpost-crime"],jQuery);