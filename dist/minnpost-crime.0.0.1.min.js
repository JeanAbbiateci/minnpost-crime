/*! minnpost-crime - v0.0.1 - 2013-04-18
* https://github.com/MinnPost/minnpost-crime
* Copyright (c) 2013 ; Licensed MIT */

var DATAPATH=DATAPATH||"../data/",mapper={};(function(e){function a(a){a=a||"total",o||(o=topojson.feature(c,c.objects["minneapolis-neighborhoods-2012-keyed.geo"])),o.features=_.map(o.features,function(e){var a=_.where(i,{neighborhood_key:e.properties.neighbor_1});return _.each(n,function(o){var t=0;_.each(a,function(e){t+=e[o]}),e.properties[o]=t}),e}),e("#crime-map").html(""),SimpleMapD3({container:"#crime-map",data:o,colorOn:!0,colorProperty:a})}var o,t="https://api.scraperwiki.com/api/1.0/datastore/sqlite?format=jsondict&name=minneapolis_aggregate_crime_data&callback=?&query=",r="SELECT * FROM `swdata` WHERE year = '2011'",n=["homicide","rape","robbery","agg_assault","burglary","larceny","auto_theft","arson","total"],i={},c={};mapper=function(o){o=o||"./data/",e.jsonp({url:t+encodeURI(r),success:function(t){i=t;var r="json";o.indexOf("proxy")>0&&(r="jsonp");var n=o+"neighborhoods/minneapolis/minneapolis-neighborhoods-2012-keyed.topo.json";e.ajax({dataType:r,url:n,success:function(e){c=e,a()}})}}),e("#crime-type-select").on("change",function(){a(e(this).val()||"total")})}})(jQuery),function(e){e(document).ready(function(){var a="https://api.scraperwiki.com/api/1.0/datastore/sqlite?format=jsondict&name=minneapolis_aggregate_crime_data&query=SELECT%20DISTINCT%20neighborhood_key%20FROM%20swdata%20ORDER%20BY%20neighborhood_key&callback=?",o="https://api.scraperwiki.com/api/1.0/datastore/sqlite?format=jsondict&name=minneapolis_aggregate_crime_data&query=SELECT%20*%20FROM%20%60swdata%60%20WHERE%20neighborhood_key%20%3D%20'[[[NEIGHBORHOOD]]]'&callback=?",t={loading:_.template(e("#template-loading").html())};e("#chart-example").html(t.loading({}));var r=function(a,r){e("#chart-example").html(t.loading({})),e.jsonp({url:o.replace("[[[NEIGHBORHOOD]]]",a),success:function(e){var a=["homicide","rape","robbery","agg_assault","burglary","larceny","auto_theft","arson"],o=[];_.each(a,function(a){o.push({name:a,data:_.map(e,function(e){return[Date.UTC(e.year,e.month,1),parseInt(e[a],10)]})})}),new Highcharts.Chart({chart:{renderTo:"chart-example",type:"spline"},title:{text:"Neighborhood crime data"},xAxis:{type:"datetime"},yAxis:{min:0,max:r},plotOptions:{spline:{marker:{enabled:!1}}},series:o})},error:function(){console.log("error")}})};e.jsonp({url:a,success:function(a){_.each(a,function(a){e("#neighborhood-select").append(e('<option value="'+a.neighborhood_key+'">'+a.neighborhood_key+"</option>"))}),e("#chart-example").html("<p><br /><br />Select neighborhood...</p>"),e("#neighborhood-select").on("change",function(){r(e(this).val(),parseInt(e("#max-select").val(),10)||50)})}})})}(jQuery,window);