/*! minnpost-crime - v0.0.1 - 2013-06-19
* https://github.com/MinnPost/minnpost-crime
* Copyright (c) 2013 ; Licensed MIT */

var mpApp=mpApp||{};mpApp["minnpost-crime"]=mpApp["minnpost-crime"]||{},_.mixin({formatNumber:function(t,n){n=n||2;var e=/(\d+)(\d{3})/;for(split=(""+t.toFixed(n)).split(".");e.test(split[0]);)split[0]=split[0].replace(e,"$1,$2");return split[0]+"."+split[1]},formatCurrency:function(t){return"$"+_.formatNumber(t,2)},formatPercent:function(t){return""+(100*t).toFixed(1)+"%"}}),_.isFunction(Backbone.$.jsonp)&&(Backbone.ajax=function(){return Backbone.$.jsonp.apply(Backbone.$,arguments)}),function(t,n){t.defaultOptions={dataPath:"./",dataCrimeQueryBase:"https://api.scraperwiki.com/api/1.0/datastore/sqlite?format=jsondict&name=minneapolis_aggregate_crime_data&callback=?&query=[[[QUERY]]]",dataCrimeQueryWhere:"notes NOT LIKE 'Added to%'",validCities:["minneapolis"],crimeStats:["total","homicide","rape","robbery","agg_assault","burglary","larceny","auto_theft","arson"]},t.templates=t.templates||{},t.getTemplate=function(e,i,a){var o="js/templates/"+e+".html";a=a||t,_.isUndefined(t.templates[o])?n.ajax({url:o,method:"GET",async:!1,contentType:"text",success:function(n){t.templates[o]=_.template(n),i.apply(a,[t.templates[o]])}}):i.apply(a,[t.templates[o]])},t.data=t.data||{},t.getLocalData=function(e){var i="http://mp-jsonproxy.herokuapp.com/proxy?callback=?&url=",a=!1,o=[];return e=_.isArray(e)?e:[e],t.options&&0===t.options.dataPath.indexOf("http")&&(a=!0),_.each(e,function(e){var s;s=a?n.jsonp({url:i+encodeURI(t.options.dataPath+e+".json")}):n.getJSON(t.options.dataPath+e+".json"),o.push(s)}),n.when.apply(n,o)}}(mpApp["minnpost-crime"],jQuery),this.mpApp=this.mpApp||{},this.mpApp["minnpost-crime"]=this.mpApp["minnpost-crime"]||{},this.mpApp["minnpost-crime"].templates=this.mpApp["minnpost-crime"].templates||{},this.mpApp["minnpost-crime"].templates["js/templates/template-application-container.html"]=function(obj){obj||(obj={});var __p="";with(_.escape,obj)__p+='<div class="mc-application-container">\n    \n  <div class="flurid mc-header">\n    <div class="row">\n      <div class="column width_1/1">\n      \n        <p>Header</p>\n      \n      </div>\n    </div>\n    \n    <div class="row messaging-container">\n      <div class="column width_1/1">\n      \n      </div>\n    </div>\n  </div>\n  \n  <div class="mc-content">\n  </div>\n    \n    \n  <div class="flurid mc-footer">\n    <div class="row">\n      <div class="column width_1/1">\n        \n        <p>Footer</p>\n      \n      </div>\n    </div>\n  </div>\n</div>';return __p},this.mpApp["minnpost-crime"].templates["js/templates/template-city.html"]=function(obj){obj||(obj={});var __p="";with(_.escape,obj)__p+='<div class="mc-city-container">\n  <div class="flurid">\n    <div class="row row-space">\n      <div class="column width_1/2">\n        <div class="inner-column-left">\n          <div class="map placeholder">\n            Map <span class="month-display"></span>\n          </div>\n        </div>\n      </div>\n      \n      <div class="column width_1/2 last">\n        <h3>Current Month</h3>\n        <p class="current-month-display">\n        </p>\n        \n        <h3>Total Crime</h3>\n      \n        <div class="column width_1/2">\n          <div class="inner-column-left">\n            <div class="stat-last-month">\n              <p>Change from last month</p>\n              <span class="stat-value"></span>\n              <span class="stat-symbol"></span>\n            </div>\n          </div>\n        </div>\n      \n        <div class="column width_1/2">\n          <div class="inner-column-left">\n            <div class="stat-last-year">\n              <p>Change from last year</p>\n              <span class="stat-value"></span>\n              <span class="stat-symbol"></span>\n            </div>\n          </div>\n        </div>\n        \n      </div>\n    </div>\n    \n    <div class="row row-space">\n      <div class="column width_1/1 last">\n        <h4>Crime over the past year</h4>\n        <div id="chart-one"></div>\n      </div>\n    </div>\n    \n    <div class="row">\n      <div class="column width_1/1 last">\n        <div class="placeholder">\n          Charts <br /><br /><br /><br /><br />\n        </div>\n      </div>\n    </div>\n  </div>\n</div>';return __p},this.mpApp["minnpost-crime"].templates["js/templates/template-loading.html"]=function(obj){obj||(obj={});var __p="";with(_.escape,obj)__p+='<div class="loading-container">\n  <div class="loading"><span>Loading...</span></div>\n</div>';return __p},function(t){t.Application=Backbone.Router.extend({routes:{"city/:city":"routeCity","neighborhood/:city/:neighborhood":"routeNeighborhood","*defaultR":"routeDefault"},initialize:function(n){_.bindAll(this),t.options=_.extend(t.defaultOptions,n),this.applicationView=new t.ViewContainer({el:t.options.el}).render(),this.cities=new t.CollectionCities,this.neighborhoods=new t.CollectionNeighborhoods,this.cityView=new t.ViewCity,this.neighborhoodView=new t.ViewNeighborhood,this.start()},start:function(){Backbone.history.start()},routeDefault:function(){this.navigate("/city/minneapolis",{trigger:!0,replace:!0})},routeCity:function(n){var e=this;-1===_.indexOf(t.options.validCities,n)&&this.routeDefault(),this.applicationView.renderGeneralLoading(),this.city=this.cities.get(n),_.isUndefined(this.city)&&(this.city=new t.ModelCity({id:n}),this.cities.add(this.city)),this.applicationView.renderContent(this.cityView,this.city),this.city.fetchData(function(){e.applicationView.renderStopGeneralLoading()})},routeNeighborhood:function(){}}),t.start=function(n){return t.router=new t.Application(n),t}}(mpApp["minnpost-crime"],jQuery),function(t,n){t.ModelCity=Backbone.Model.extend({initialize:function(){},setStats:function(t){return t=t||"total",this.set("lastMonthChange",this.getMonthChange(this.get("lastMonthYear"),this.get("lastMonthMonth"),t)),this.set("lastYearMonthChange",this.getMonthChange(this.get("currentYear")-1,this.get("currentMonth"),t)),this},getLastYearData:function(t){t=t||"total";var n=[];return _.isObject(this.get("crimeData"))&&_.each(this.get("crimeData"),function(e,i){_.each(e,function(e,a){n.push([i+"-"+a,e[t]])})}),n},getMonthChange:function(t,n,e,i,a){i=i||this.get("currentYear"),a=a||this.get("currentMonth"),e=e||"total";var o=this.getCrimeByMonth(t,n,e),s=this.getCrimeByMonth(i,a,e);return(s-o)/(0===o?.1:o)},getCrimeByMonth:function(t,n,e){return e=e||"total",this.get("crimeData")[t][n][e]},setLastMonth:function(){var t=this.get("currentMonth"),n=this.get("currentYear"),e=[n,t-1];return 1==t&&(e=[n-1,12]),this.set("lastMonthMonth",e[1]),this.set("lastMonthYear",e[0]),this},fetchData:function(t,e){var i=this;return e=e||this,this.fetchRecentMonth(function(a,o){var s=[];this.set("currentMonth",o),this.set("currentYear",a),this.setLastMonth(),s.push(this.fetchDataPreviousYear(a,o)),n.when.apply(n,s).done(function(){var n=i.get("data")||{};_.each(arguments[0],function(t){n[t.year]=n[t.year]||{},n[t.year][t.month]=t}),i.set("crimeData",n),i.setStats(),t.apply(e,[])})},this),this},fetchRecentMonth:function(e,i){i=i||this;var a="SELECT month, year FROM swdata ORDER BY year || '-' || month DESC LIMIT 1",o=n.jsonp({url:t.options.dataCrimeQueryBase.replace("[[[QUERY]]]",encodeURI(a))});return _.isFunction(e)&&n.when(o).done(function(t){e.apply(i,[t[0].year,t[0].month])}),o},fetchDataPreviousYear:function(e,i,a,o){var s=[];s.push("SELECT year, month"),_.each(t.options.crimeStats,function(t){s.push(", SUM("+t+") AS "+t)}),s.push(" FROM swdata WHERE "+t.options.dataCrimeQueryWhere),s.push(" AND ((year = "+e+" AND month <= "+i+") "),s.push(" OR (year = "+(e-1)+" AND month >= "+i+"))"),s.push(" GROUP BY year, month ORDER BY year DESC, month DESC");var r=n.jsonp({url:t.options.dataCrimeQueryBase.replace("[[[QUERY]]]",encodeURI(s.join("")))});return _.isFunction(a)&&n.when(r).done(function(t){a.apply(o,[t[0]])}),r}}),t.ModelNeighborhood=Backbone.Model.extend({})}(mpApp["minnpost-crime"],jQuery),function(t){t.CollectionCities=Backbone.Collection.extend({model:t.ModelCity}),t.CollectionNeighborhoods=Backbone.Collection.extend({model:t.ModelNeighborhood})}(mpApp["minnpost-crime"],jQuery),function(t,n){t.ViewContainer=Backbone.View.extend({render:function(){return t.getTemplate("template-application-container",function(t){n(this.el).html(t({}))},this),this},renderContent:function(t,e){var i=!1;this.el+" .mc-content col",this.contentViewCID!==t.cid&&(i=!0),t.setElement(n(this.el).find(".mc-content")),t.model=e,i&&t.render(),t.stickit(),this.contentViewCID=t.cid},renderLoading:function(e){var i=_.isUndefined(e)?n(this.el):n(this.el).find(e);return t.getTemplate("template-loading",function(t){i.html(t({}))},this),this},renderGeneralLoading:function(){return this.renderLoading(".messaging-container .column"),this},renderStopGeneralLoading:function(){return this.$el.find(".messaging-container .loading").fadeOut(function(){n(this).remove()}),this}}),t.ViewBinding=Backbone.View.extend({bindUpdateCount:function(t,n){var e,i,a=_.isNaN(parseInt(t.text(),10))?0:parseInt(t.text(),10);if(_.isNumber(n)&&n!=a){var o=n>a;e=(n-a)/40,i=setInterval(function(){a+=e,t.html(_.formatPercent(a)),(o&&a>=n||!o&&n>=a)&&(t.html(_.formatPercent(n)),clearInterval(i))},20)}else t.html(n)},bindUpdateFade:function(t,n){t.fadeOut("fast",function(){t.html(n).fadeIn("fast")})}}),t.ViewCity=t.ViewBinding.extend({model:t.ModelCity,bindings:{".current-month-display":{observe:["currentMonth","currentYear"],update:function(t,n,e,i){var a=n?moment(""+n,"MM").format("MMMM"):"",o=e.get("currentYear");this.bindUpdateFade(t,a&&o?a+", "+o:"",e,i)}},".stat-last-month .stat-value":{observe:"lastMonthChange",update:"bindUpdateCount"},".stat-last-year .stat-value":{observe:"lastYearMonthChange",update:"bindUpdateCount"},"#chart-one":{observe:"crimeData",update:function(t,e,i){data=i.getLastYearData(),_.isArray(data)&&data.length>0&&n.jqplot("chart-one",[data],this.cityPlotOptions)}}},cityPlotOptions:{seriesColors:["#10517F"],grid:{drawBorder:!1,background:"#fafafa",gridLineColor:"#dddddd",shadow:!1},series:{renderer:n.jqplot.BarRenderer,lineWidth:1.5,shadow:!1,markerOptions:{size:0,shadow:!1},rendererOptions:{barPadding:0,barMargin:2}},axes:{xaxis:{renderer:n.jqplot.CategoryAxisRenderer}}},render:function(){return t.getTemplate("template-city",function(t){this.$el.html(t(this.model.toJSON()))},this),this}}),t.ViewNeighborhood=t.ViewBinding.extend({})}(mpApp["minnpost-crime"],jQuery);