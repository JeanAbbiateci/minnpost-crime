/*! minnpost-crime - v0.0.1 - 2013-04-18
* https://github.com/MinnPost/minnpost-crime
* Copyright (c) 2013 ; Licensed MIT */

var mapper={},neighborhood2011GeoJSON;(function(e){function a(a){a=a||"total",o||(o=topojson.feature(p,p.objects["minneapolis-neighborhoods-2012-keyed.geo"])),o.features=_.map(o.features,function(e){var a=_.where(i,{neighborhood_key:e.properties.neighbor_1});return _.each(r,function(o){var t=0;_.each(a,function(e){t+=e[o]}),e.properties[o]=t}),e}),e("#crime-map").html(""),neighborhood2011GeoJSON=o,SimpleMapD3({container:"#crime-map",data:o,colorOn:!0,colorProperty:a,tooltipContent:c})}var o,t="https://api.scraperwiki.com/api/1.0/datastore/sqlite?format=jsondict&name=minneapolis_aggregate_crime_data&callback=?&query=",n="SELECT * FROM `swdata` WHERE year = '2011'",r=["homicide","rape","robbery","agg_assault","burglary","larceny","auto_theft","arson","total"],i={},p={},c=_.template(e("#template-tooltip-crime").html());mapper=function(o){o=o||"./data/neighborhoods/minneapolis/",e.jsonp({url:t+encodeURI(n),success:function(t){i=t;var n="json";o.indexOf("proxy")>0&&(n="jsonp");var r=o+"minneapolis-neighborhoods-2012-keyed.topo.json";e.ajax({dataType:n,url:r,success:function(e){p=e,a()}})}}),e("#crime-type-select").on("change",function(){a(e(this).val()||"total")})}})(jQuery),function(e){e(document).ready(function(){var a="https://api.scraperwiki.com/api/1.0/datastore/sqlite?format=jsondict&name=minneapolis_aggregate_crime_data&query=SELECT%20DISTINCT%20neighborhood_key%20FROM%20swdata%20ORDER%20BY%20neighborhood_key&callback=?",o="https://api.scraperwiki.com/api/1.0/datastore/sqlite?format=jsondict&name=minneapolis_aggregate_crime_data&query=SELECT%20*%20FROM%20%60swdata%60%20WHERE%20neighborhood_key%20%3D%20'[[[NEIGHBORHOOD]]]'&callback=?",t={loading:_.template(e("#template-loading").html())};e("#chart-example").html(t.loading({}));var n=function(a,n){e("#chart-example").html(t.loading({})),e.jsonp({url:o.replace("[[[NEIGHBORHOOD]]]",a),success:function(e){var a=["homicide","rape","robbery","agg_assault","burglary","larceny","auto_theft","arson"],o=[];_.each(a,function(a){o.push({name:a,data:_.map(e,function(e){return[Date.UTC(e.year,e.month,1),parseInt(e[a],10)]})})}),new Highcharts.Chart({chart:{renderTo:"chart-example",type:"spline"},title:{text:"Neighborhood crime data"},xAxis:{type:"datetime"},yAxis:{min:0,max:n},plotOptions:{spline:{marker:{enabled:!1}}},series:o})},error:function(){console.log("error")}})};e.jsonp({url:a,success:function(a){_.each(a,function(a){e("#neighborhood-select").append(e('<option value="'+a.neighborhood_key+'">'+a.neighborhood_key+"</option>"))}),e("#chart-example").html("<p><br /><br />Select neighborhood...</p>"),e("#neighborhood-select").on("change",function(){n(e(this).val(),parseInt(e("#max-select").val(),10)||50)})}})})}(jQuery,window);var demographics={};(function(e){function a(){neighborhood2011GeoJSON&&t&&(n=neighborhood2011GeoJSON,_.each(t.data,function(e,a){_.each(t.data[a],function(e,o){t.meta[o]&&"%"==t.meta[o].type&&(t.data[a][o]=e/100)})}),n.features=_.map(n.features,function(e){return e.properties=_.extend(e.properties,t.data["minneapolis_"+e.properties.neighbor_1]),e}),_.each(i,function(a){e("#demographics-select-1").append(e('<option value="'+a+'">'+a+"</option>")),e("#demographics-select-2").append(e('<option value="'+a+'">'+a+"</option>"))}),_.each(t.meta,function(a){"MARGIN OF ERROR"!=a.data&&(e("#demographics-select-1").append(e('<option value="'+a.key+'">'+a.name+" ("+a.type+" "+a.data+")</option>")),e("#demographics-select-2").append(e('<option value="'+a.key+'">'+a.name+" ("+a.type+" "+a.data+")</option>")))}))}function o(a,o){if(neighborhood2011GeoJSON&&t&&a&&o){var i=_.template(r.replace("{{{PROP1}}}",a).replace("{{{PROP2}}}",o).replace("{{{PROP1}}}",a).replace("{{{PROP2}}}",o));e("#demographic-map-1").html(""),SimpleMapD3({container:"#demographic-map-1",data:n,colorOn:!0,colorProperty:a,tooltipContent:i}),e("#demographic-map-2").html(""),SimpleMapD3({container:"#demographic-map-2",data:n,colorOn:!0,colorProperty:o,tooltipContent:i})}}var t,n,r=e("#template-tooltip-demographics").html(),i=["total","homicide","rape","robbery","agg_assault","burglary","larceny","auto_theft","arson"];demographics=function(n){n=n||"./data/demographics/2010/";var r="json";n.indexOf("proxy")>0&&(r="jsonp");var i=n+"twin-cities-neighborhood-demographics-2010.json";e.ajax({dataType:r,url:i,success:function(e){t=e,a()}}),e("#demographics-submit").on("click",function(a){a.preventDefault(),o(e("#demographics-select-1").val(),e("#demographics-select-2").val())}),e("#demographics-load-data").on("click",function(e){e.preventDefault(),a()})}})(jQuery);